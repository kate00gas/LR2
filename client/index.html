<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TastyHub</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome for icons -->
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css" rel="stylesheet">
  <style>
    /* Custom styles */
    .restaurant-card {
      position: relative;
      height: 200px;
      background-size: cover;
      background-position: center;
      color: white;
      margin-bottom: 1rem;
      border-radius: 10px;
      overflow: hidden;
    }
    .restaurant-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1;
    }
    .restaurant-card-content {
      position: relative;
      z-index: 2;
      padding: 1rem;
      height: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .restaurant-details {
      background: rgba(255, 255, 255, 0.9);
      color: black;
      padding: 1rem;
      position: absolute;
      right: -300px;
      top: 0;
      height: 100%;
      width: 300px;
      transition: right 0.3s ease;
    }
    .restaurant-card:hover .restaurant-details {
      right: 0;
    }
    .menu-item-img {
      height: 150px;
      object-fit: cover;
      width: 100%;
    }
    .category-tag {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.9rem;
    }
    .order-summary {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: white;
      padding: 1rem;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    .quantity-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .admin-sidebar {
      position: fixed;
      top: 70px;
      left: 0;
      height: calc(100vh - 70px);
      width: 250px;
      background: #f8f9fa;
      transform: translateX(-250px);
      transition: transform 0.3s ease;
      z-index: 1000;
    }
    .admin-sidebar.open {
      transform: translateX(0);
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- Scripts (local) -->
  <script src="/react.min.js"></script>
  <script src="/react-dom.min.js"></script>
  <script src="/react-router-dom.min.js"></script>
  <script src="/axios.min.js"></script>
  <script src="/bootstrap.bundle.min.js"></script>
  <script src="/babel.min.js"></script>

  <script type="text/babel">
    const { createContext, useState, useEffect, useContext, useMemo } = React;
    const { BrowserRouter, Routes, Route, Link, useNavigate, useParams, useLocation } = window.ReactRouter;

    // Context for auth and cart
    const AuthContext = createContext();
    const CartContext = createContext();

    // API base URL
    const API_BASE_URL = 'http://localhost:8000/api/v1';

    // Auth Provider
    const AuthProvider = ({ children }) => {
      const [user, setUser] = useState(null);
      const [token, setToken] = useState(localStorage.getItem('token'));

      useEffect(() => {
        if (token) {
          console.log('Fetching user data with token:', token);
          axios.get(`${API_BASE_URL}/auth/me`, {
            headers: { Authorization: `Bearer ${token}` }
          }).then(res => {
            console.log('User data:', res.data);
            setUser(res.data);
          }).catch(err => {
            console.error('Error fetching user:', err);
            logout();
          });
        }
      }, [token]);

      const login = async (username, password, role = 'user') => {
        try {
          const res = await axios.post(`${API_BASE_URL}/auth/login`, {
            username,
            password
          });
          const { access_token } = res.data;
          localStorage.setItem('token', access_token);
          setToken(access_token);
          const userRes = await axios.get(`${API_BASE_URL}/auth/me`, {
            headers: { Authorization: `Bearer ${access_token}` }
          });
          if (role === 'admin' && userRes.data.role !== 'admin') {
            throw new Error('Not an admin');
          }
          setUser(userRes.data);
          return true;
        } catch (err) {
          console.error('Login error:', err);
          throw new Error(err.response?.data?.detail || 'Login failed');
        }
      };

      const register = async (username, password, phone_number) => {
        try {
          const res = await axios.post(`${API_BASE_URL}/auth/users/`, {
            username,
            password,
            phone_number,
            role: 'user'
          });
          setUser(res.data);
          return true;
        } catch (err) {
          console.error('Register error:', err);
          throw new Error(err.response?.data?.detail || 'Registration failed');
        }
      };

      const logout = () => {
        localStorage.removeItem('token');
        setToken(null);
        setUser(null);
      };

      return (
        <AuthContext.Provider value={{ user, token, login, register, logout }}>
          {children}
        </AuthContext.Provider>
      );
    };

    // Cart Provider
    const CartProvider = ({ children }) => {
      const [cart, setCart] = useState({});
      const [restaurantId, setRestaurantId] = useState(null);

      const addItem = (itemId, quantity, item) => {
        setCart(prev => ({
          ...prev,
          [itemId]: { quantity, item }
        }));
      };

      const removeItem = (itemId) => {
        setCart(prev => {
          const newCart = { ...prev };
          delete newCart[itemId];
          return newCart;
        });
      };

      const clearCart = () => {
        setCart({});
        setRestaurantId(null);
      };

      const total = useMemo(() => {
        return Object.values(cart).reduce((sum, { quantity, item }) => {
          return sum + (item.price * quantity);
        }, 0).toFixed(2);
      }, [cart]);

      return (
        <CartContext.Provider value={{ cart, restaurantId, setRestaurantId, addItem, removeItem, clearCart, total }}>
          {children}
        </CartContext.Provider>
      );
    };

    // Navigation guard for cart
    const useBeforeUnload = (hasChanges) => {
      useEffect(() => {
        const handler = (e) => {
          if (hasChanges) {
            e.preventDefault();
            e.returnValue = '';
          }
        };
        window.addEventListener('beforeunload', handler);
        return () => window.removeEventListener('beforeunload', handler);
      }, [hasChanges]);
    };

    // Navbar Component
    const Navbar = () => {
      const { user, logout } = useContext(AuthContext);
      const navigate = useNavigate();

      return (
        <nav className="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
          <div className="container-fluid">
            <Link className="navbar-brand" to="/">TastyHub</Link>
            <div className="navbar-nav ms-auto">
              {user ? (
                <>
                  <span className="nav-link">{user.username}</span>
                  <button className="btn btn-outline-light ms-2" onClick={() => {
                    logout();
                    navigate('/');
                  }}>Logout</button>
                </>
              ) : (
                <>
                  <Link className="nav-link" to="/register">Register</Link>
                  <Link className="nav-link" to="/login">Login</Link>
                </>
              )}
            </div>
          </div>
        </nav>
      );
    };

    // Homepage Component
    const Home = () => {
      const [restaurants, setRestaurants] = useState([]);
      const [error, setError] = useState(null);

      useEffect(() => {
        console.log('Fetching restaurants');
        axios.get(`${API_BASE_URL}/restaurants/`)
          .then(res => {
            console.log('Restaurants:', res.data);
            setRestaurants(res.data);
          })
          .catch(err => {
            console.error('Error fetching restaurants:', err);
            setError(err.response?.data?.detail || 'Failed to load restaurants');
          });
      }, []);

      return (
        <div className="container mt-5 pt-5">
          {error && <div className="alert alert-danger">{error}</div>}
          {restaurants.length === 0 && !error && (
            <div className="alert alert-info">No restaurants available.</div>
          )}
          {restaurants.map(restaurant => (
            <div
              key={restaurant.restaurant_id}
              className="restaurant-card"
              style={{ backgroundImage: `url(https://via.placeholder.com/800x200?text=${restaurant.name})` }}
            >
              <div className="restaurant-card-content">
                <div>
                  <h3>{restaurant.name}</h3>
                  <Link to={`/restaurant/${restaurant.restaurant_id}`} className="btn btn-primary">Go</Link>
                </div>
                <div className="restaurant-details">
                  <p>{restaurant.description || 'No description available'}</p>
                  <p><strong>Address:</strong> {restaurant.address}</p>
                  <p><strong>Phone:</strong> {restaurant.phone_number || 'N/A'}</p>
                </div>
              </div>
            </div>
          ))}
        </div>
      );
    };

    // Restaurant Menu Component
    const RestaurantMenu = () => {
      const { restaurantId } = useParams();
      const { cart, addItem, removeItem, setRestaurantId, total } = useContext(CartContext);
      const [restaurant, setRestaurant] = useState(null);
      const [error, setError] = useState(null);
      const navigate = useNavigate();
      const hasItems = Object.keys(cart).length > 0;

      useBeforeUnload(hasItems);

      useEffect(() => {
        setRestaurantId(restaurantId);
        console.log('Fetching restaurant:', restaurantId);
        axios.get(`${API_BASE_URL}/restaurants/${restaurantId}`)
          .then(res => {
            console.log('Restaurant:', res.data);
            setRestaurant(res.data);
          })
          .catch(err => {
            console.error('Error fetching restaurant:', err);
            setError(err.response?.data?.detail || 'Failed to load menu');
          });
      }, [restaurantId]);

      const handleBack = () => {
        if (hasItems) {
          if (window.confirm('Your selection will be reset. Proceed?')) {
            navigate('/');
          }
        } else {
          navigate('/');
        }
      };

      if (error) return <div className="container mt-5 pt-5"><div className="alert alert-danger">{error}</div></div>;
      if (!restaurant) return <div className="container mt-5 pt-5">Loading...</div>;

      return (
        <div className="container mt-5 pt-5">
          <button className="btn btn-outline-secondary mb-3" onClick={handleBack}>Back</button>
          <h2>{restaurant.name} Menu</h2>
          <div className="row">
            {restaurant.menu_items.map(item => (
              <div key={item.item_id} className="col-md-4 mb-4">
                <div className="card">
                  <div className="position-relative">
                    <img src={`https://via.placeholder.com/300x150?text=${item.name}`} className="menu-item-img" alt={item.name} />
                    {item.category && <span className="category-tag">{item.category}</span>}
                  </div>
                  <div className="card-body">
                    <h5 className="card-title">{item.name}</h5>
                    <p className="card-text">{item.description || 'No description'}</p>
                    <p className="card-text"><strong>${item.price.toFixed(2)}</strong></p>
                    <div className="d-flex align-items-center">
                      <button
                        className="btn btn-outline-danger quantity-btn"
                        disabled={!cart[item.item_id] || cart[item.item_id].quantity === 0}
                        onClick={() => {
                          if (cart[item.item_id].quantity === 1) {
                            removeItem(item.item_id);
                          } else {
                            addItem(item.item_id, cart[item.item_id].quantity - 1, item);
                          }
                        }}
                      >-</button>
                      <span className="mx-3">{cart[item.item_id]?.quantity || 0}</span>
                      <button
                        className="btn btn-outline-success quantity-btn"
                        onClick={() => addItem(item.item_id, (cart[item.item_id]?.quantity || 0) + 1, item)}
                      >+</button>
                    </div>
                  </div>
                </div>
              </div>
            ))}
          </div>
          {hasItems && (
            <div className="order-summary">
              <h5>Order Summary</h5>
              <p>Total: ${total}</p>
              <Link to="/order" className="btn btn-primary">Order</Link>
            </div>
          )}
        </div>
      );
    };

    // Order Form Component
    const OrderForm = () => {
      const { user } = useContext(AuthContext);
      const { cart, restaurantId, total, clearCart } = useContext(CartContext);
      const [formData, setFormData] = useState({
        username: user?.username || '',
        phone_number: user?.phone_number || '',
        delivery_address: user?.delivery_address || ''
      });
      const [error, setError] = useState(null);
      const navigate = useNavigate();

      useEffect(() => {
        if (!restaurantId || Object.keys(cart).length === 0) {
          navigate('/');
        }
      }, [restaurantId, cart]);

      const handleSubmit = async () => {
        try {
          const orderData = {
            restaurant_id: restaurantId,
            delivery_address: formData.delivery_address,
            items: Object.entries(cart).map(([itemId, { quantity }]) => ({
              item_id: itemId,
              quantity
            }))
          };
          console.log('Submitting order:', orderData);
          await axios.post(`${API_BASE_URL}/orders/`, orderData, {
            headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
          });
          navigate('/order-success', { state: { total, restaurant: cart[Object.keys(cart)[0]].item.restaurant } });
          clearCart();
        } catch (err) {
          console.error('Order error:', err);
          setError(err.response?.data?.detail || 'Failed to place order');
        }
      };

      return (
        <div className="container mt-5 pt-5">
          <button className="btn btn-outline-secondary mb-3" onClick={() => navigate(-1)}>Back</button>
          {error && <div className="alert alert-danger">{error}</div>}
          <div className="row">
            <div className="col-md-6">
              <h2>Place Order</h2>
              <div className="mb-3">
                <label className="form-label">Username</label>
                <input
                  type="text"
                  className="form-control"
                  value={formData.username}
                  disabled={!!user}
                  onChange={e => setFormData({ ...formData, username: e.target.value })}
                />
              </div>
              <div className="mb-3">
                <label className="form-label">Phone Number</label>
                <input
                  type="tel"
                  className="form-control"
                  value={formData.phone_number}
                  disabled={!!user}
                  onChange={e => setFormData({ ...formData, phone_number: e.target.value })}
                />
              </div>
              <div className="mb-3">
                <label className="form-label">Delivery Address</label>
                <textarea
                  className="form-control"
                  value={formData.delivery_address}
                  onChange={e => setFormData({ ...formData, delivery_address: e.target.value })}
                ></textarea>
              </div>
              <button className="btn btn-primary" onClick={handleSubmit}>Order</button>
            </div>
            <div className="col-md-6">
              <h3>Order Summary</h3>
              <p><strong>Restaurant:</strong> {cart[Object.keys(cart)[0]]?.item.restaurant?.name || 'N/A'}</p>
              <ul>
                {Object.values(cart).map(({ item, quantity }) => (
                  <li key={item.item_id}>
                    {item.name} x {quantity} - ${(item.price * quantity).toFixed(2)}
                  </li>
                ))}
              </ul>
              <p><strong>Total:</strong> ${total}</p>
            </div>
          </div>
        </div>
      );
    };

    // Order Success Component
    const OrderSuccess = () => {
      const { state } = useLocation();
      const navigate = useNavigate();

      return (
        <div className="container mt-5 pt-5 text-center">
          <h2>Order Placed Successfully!</h2>
          <p>Your order for ${state?.total || 'N/A'} at {state?.restaurant?.name || 'N/A'} has been placed.</p>
          <p>We will contact you soon to confirm your order.</p>
          <button className="btn btn-primary" onClick={() => navigate('/')}>Back to Home</button>
        </div>
      );
    };

    // Login Component
    const Login = () => {
      const [formData, setFormData] = useState({ username: '', password: '' });
      const [error, setError] = useState(null);
      const { login } = useContext(AuthContext);
      const navigate = useNavigate();

      const handleSubmit = async () => {
        try {
          await login(formData.username, formData.password);
          navigate('/');
        } catch (err) {
          console.error('Login error:', err);
          setError(err.message);
        }
      };

      return (
        <div className="container mt-5 pt-5">
          <h2>Login</h2>
          {error && <div className="alert alert-danger">{error}</div>}
          <div className="mb-3">
            <label className="form-label">Username</label>
            <input
              type="text"
              className="form-control"
              value={formData.username}
              onChange={e => setFormData({ ...formData, username: e.target.value })}
            />
          </div>
          <div className="mb-3">
            <label className="form-label">Password</label>
            <input
              type="password"
              className="form-control"
              value={formData.password}
              onChange={e => setFormData({ ...formData, password: e.target.value })}
            />
          </div>
          <button className="btn btn-primary" onClick={handleSubmit}>Login</button>
          <p className="mt-3">
            Don't have an account? <Link to="/register">Register</Link>
          </p>
        </div>
      );
    };

    // Register Component
    const Register = () => {
      const [formData, setFormData] = useState({ username: '', password: '', phone_number: '' });
      const [error, setError] = useState(null);
      const { register } = useContext(AuthContext);
      const navigate = useNavigate();

      const handleSubmit = async () => {
        try {
          await register(formData.username, formData.password, formData.phone_number);
          navigate('/login');
        } catch (err) {
          console.error('Register error:', err);
          setError(err.message);
        }
      };

      return (
        <div className="container mt-5 pt-5">
          <h2>Register</h2>
          {error && <div className="alert alert-danger">{error}</div>}
          <div className="mb-3">
            <label className="form-label">Username</label>
            <input
              type="text"
              className="form-control"
              value={formData.username}
              onChange={e => setFormData({ ...formData, username: e.target.value })}
            />
          </div>
          <div className="mb-3">
            <label className="form-label">Password</label>
            <input
              type="password"
              className="form-control"
              value={formData.password}
              onChange={e => setFormData({ ...formData, password: e.target.value })}
            />
          </div>
          <div className="mb-3">
            <label className="form-label">Phone Number</label>
            <input
              type="tel"
              className="form-control"
              value={formData.phone_number}
              onChange={e => setFormData({ ...formData, phone_number: e.target.value })}
            />
          </div>
          <button className="btn btn-primary" onClick={handleSubmit}>Register</button>
          <p className="mt-3">
            Already have an account? <Link to="/login">Login</Link>
          </p>
        </div>
      );
    };

    // Admin Login Modal
    const AdminLoginModal = ({ show, onClose }) => {
      const [formData, setFormData] = useState({ username: '', password: '' });
      const [error, setError] = useState(null);
      const { login } = useContext(AuthContext);
      const navigate = useNavigate();

      const handleSubmit = async () => {
        try {
          await login(formData.username, formData.password, 'admin');
          onClose();
          navigate('/admin');
        } catch (err) {
          console.error('Admin login error:', err);
          setError(err.message);
        }
      };

      if (!show) return null;

      return (
        <div className="modal show d-block" style={{ backgroundColor: 'rgba(0,0,0,0.5)' }}>
          <div className="modal-dialog">
            <div className="modal-content">
              <div className="modal-header">
                <h5 className="modal-title">Admin Login</h5>
                <button type="button" className="btn-close" onClick={onClose}></button>
              </div>
              <div className="modal-body">
                {error && <div className="alert alert-danger">{error}</div>}
                <div className="mb-3">
                  <label className="form-label">Username</label>
                  <input
                    type="text"
                    className="form-control"
                    value={formData.username}
                    onChange={e => setFormData({ ...formData, username: e.target.value })}
                  />
                </div>
                <div className="mb-3">
                  <label className="form-label">Password</label>
                  <input
                    type="password"
                    className="form-control"
                    value={formData.password}
                    onChange={e => setFormData({ ...formData, password: e.target.value })}
                  />
                </div>
              </div>
              <div className="modal-footer">
                <button type="button" className="btn btn-secondary" onClick={onClose}>Close</button>
                <button type="button" className="btn btn-primary" onClick={handleSubmit}>Login</button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // Admin Dashboard
    const AdminDashboard = () => {
      const { user, logout } = useContext(AuthContext);
      const [showSidebar, setShowSidebar] = useState(false);
      const [showLogin, setShowLogin] = useState(!user || user.role !== 'admin');
      const navigate = useNavigate();

      if (!user || user.role !== 'admin') {
        return <AdminLoginModal show={showLogin} onClose={() => navigate('/')} />;
      }

      return (
        <div>
          <nav className="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
            <div className="container-fluid">
              <button className="btn btn-outline-light me-2" onClick={() => setShowSidebar(!showSidebar)}>
                <i className="fas fa-bars"></i>
              </button>
              <span className="navbar-brand">TastyHub Admin</span>
              <div className="navbar-nav ms-auto">
                <button className="btn btn-outline-light" onClick={() => {
                  logout();
                  navigate('/');
                }}>Logout</button>
              </div>
            </div>
          </nav>
          <div className={`admin-sidebar ${showSidebar ? 'open' : ''}`}>
            <ul className="list-group">
              <li className="list-group-item">
                <Link to="/admin/restaurants" onClick={() => setShowSidebar(false)}>Restaurants</Link>
              </li>
              <li className="list-group-item">
                <Link to="/admin/orders" onClick={() => setShowSidebar(false)}>Orders</Link>
              </li>
              <li className="list-group-item">
                <Link to="/admin/update-status" onClick={() => setShowSidebar(false)}>Update Order Status</Link>
              </li>
              <li className="list-group-item">
                <Link to="/admin/add-restaurant" onClick={() => setShowSidebar(false)}>Add Restaurant</Link>
              </li>
              <li className="list-group-item">
                <Link to="/admin/users" onClick={() => setShowSidebar(false)}>Users</Link>
              </li>
            </ul>
          </div>
          <div className="container mt-5 pt-5">
            <Routes>
              <Route path="/" element={<h2>Welcome to Admin Dashboard</h2>} />
              <Route path="/restaurants" element={<AdminRestaurants />} />
              <Route path="/restaurants/:restaurantId/menu" element={<AdminMenuItems />} />
              <Route path="/restaurants/:restaurantId/add-item" element={<AdminAddMenuItem />} />
              <Route path="/orders" element={<AdminOrders />} />
              <Route path="/update-status" element={<AdminUpdateStatus />} />
              <Route path="/add-restaurant" element={<AdminAddRestaurant />} />
              <Route path="/users" element={<AdminUsers />} />
            </Routes>
          </div>
        </div>
      );
    };

    // Admin Restaurants
    const AdminRestaurants = () => {
      const [restaurants, setRestaurants] = useState([]);
      const [error, setError] = useState(null);

      useEffect(() => {
        console.log('Fetching admin restaurants');
        axios.get(`${API_BASE_URL}/admin/restaurants/`, {
          headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
        }).then(res => {
          console.log('Admin restaurants:', res.data);
          setRestaurants(res.data);
        }).catch(err => {
          console.error('Error fetching admin restaurants:', err);
          setError(err.response?.data?.detail || 'Failed to load restaurants');
        });
      }, []);

      const handleDelete = async (id) => {
        if (window.confirm('Are you sure you want to delete this restaurant?')) {
          try {
            await axios.delete(`${API_BASE_URL}/admin/restaurants/${id}`, {
              headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
            });
            setRestaurants(restaurants.filter(r => r.restaurant_id !== id));
          } catch (err) {
            console.error('Delete restaurant error:', err);
            setError(err.response?.data?.detail || 'Failed to delete restaurant');
          }
        }
      };

      return (
        <div>
          <h2>Restaurants</h2>
          {error && <div className="alert alert-danger">{error}</div>}
          {restaurants.length === 0 && !error && (
            <div className="alert alert-info">No restaurants available.</div>
          )}
          <table className="table table-striped">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Description</th>
                <th>Address</th>
                <th>Phone</th>
                <th>Email</th>
                <th>Active</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {restaurants.map(r => (
                <tr key={r.restaurant_id}>
                  <td>{r.restaurant_id}</td>
                  <td>{r.name}</td>
                  <td>{r.description}</td>
                  <td>{r.address}</td>
                  <td>{r.phone_number}</td>
                  <td>{r.email}</td>
                  <td>{r.is_active ? 'Yes' : 'No'}</td>
                  <td>
                    <Link to={`/admin/restaurants/${r.restaurant_id}/menu`} className="btn btn-info btn-sm">View Menu</Link>
                    <button className="btn btn-danger btn-sm ms-2" onClick={() => handleDelete(r.restaurant_id)}>Delete</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      );
    };

    // Admin Menu Items
    const AdminMenuItems = () => {
      const { restaurantId } = useParams();
      const [items, setItems] = useState([]);
      const [error, setError] = useState(null);

      useEffect(() => {
        console.log('Fetching menu items for restaurant:', restaurantId);
        axios.get(`${API_BASE_URL}/admin/restaurants/${restaurantId}/menu/`, {
          headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
        }).then(res => {
          console.log('Menu items:', res.data);
          setItems(res.data);
        }).catch(err => {
          console.error('Error fetching menu items:', err);
          setError(err.response?.data?.detail || 'Failed to load menu items');
        });
      }, [restaurantId]);

      const handleDelete = async (id) => {
        if (window.confirm('Are you sure you want to delete this menu item?')) {
          try {
            await axios.delete(`${API_BASE_URL}/admin/menu-items/${id}`, {
              headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
            });
            setItems(items.filter(i => i.item_id !== id));
          } catch (err) {
            console.error('Delete menu item error:', err);
            setError(err.response?.data?.detail || 'Failed to delete menu item');
          }
        }
      };

      return (
        <div>
          <h2>Menu Items</h2>
          {error && <div className="alert alert-danger">{error}</div>}
          <Link to={`/admin/restaurants/${restaurantId}/add-item`} className="btn btn-primary mb-3">Add New Item</Link>
          {items.length === 0 && !error && (
            <div className="alert alert-info">No menu items available.</div>
          )}
          <table className="table table-striped">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Description</th>
                <th>Price</th>
                <th>Category</th>
                <th>Available</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {items.map(i => (
                <tr key={i.item_id}>
                  <td>{i.item_id}</td>
                  <td>{i.name}</td>
                  <td>{i.description}</td>
                  <td>${i.price?.toFixed(2) || 'N/A'}</td>
                  <td>{i.category}</td>
                  <td>{i.is_available ? 'Yes' : 'No'}</td>
                  <td>
                    <button className="btn btn-danger btn-sm" onClick={() => handleDelete(i.item_id)}>Delete</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      );
    };

    // Admin Add Menu Item
    const AdminAddMenuItem = () => {
      const { restaurantId } = useParams();
      const [formData, setFormData] = useState({
        name: '',
        description: '',
        price: '',
        category: '',
        is_available: true
      });
      const [error, setError] = useState(null);
      const navigate = useNavigate();

      const handleSubmit = async () => {
        try {
          const payload = {
            ...formData,
            restaurant_id: restaurantId,
            price: parseFloat(formData.price) || 0
          };
          console.log('Adding menu item:', payload);
          await axios.post(`${API_BASE_URL}/admin/menu-items/`, payload, {
            headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
          });
          navigate(`/admin/restaurants/${restaurantId}/menu`);
        } catch (err) {
          console.error('Add menu item error:', err);
          setError(err.response?.data?.detail || 'Failed to add menu item');
        }
      };

      return (
        <div>
          <h2>Add Menu Item</h2>
          {error && <div className="alert alert-danger">{error}</div>}
          <div className="mb-3">
            <label className="form-label">Name</label>
            <input
              type="text"
              className="form-control"
              value={formData.name}
              onChange={e => setFormData({ ...formData, name: e.target.value })}
            />
          </div>
          <div className="mb-3">
            <label className="form-label">Description</label>
            <textarea
              className="form-control"
              value={formData.description}
              onChange={e => setFormData({ ...formData, description: e.target.value })}
            ></textarea>
          </div>
          <div className="mb-3">
            <label className="form-label">Price</label>
            <input
              type="number"
              className="form-control"
              value={formData.price}
              onChange={e => setFormData({ ...formData, price: e.target.value })}
            />
          </div>
          <div className="mb-3">
            <label className="form-label">Category</label>
            <input
              type="text"
              className="form-control"
              value={formData.category}
              onChange={e => setFormData({ ...formData, category: e.target.value })}
            />
          </div>
          <div className="mb-3">
            <label className="form-label">Available</label>
            <select
              className="form-control"
              value={formData.is_available}
              onChange={e => setFormData({ ...formData, is_available: e.target.value === 'true' })}
            >
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </div>
          <button className="btn btn-primary" onClick={handleSubmit}>Add Item</button>
        </div>
      );
    };

    // Admin Orders
    const AdminOrders = () => {
      const [orders, setOrders] = useState([]);
      const [error, setError] = useState(null);

      useEffect(() => {
        console.log('Fetching admin orders');
        axios.get(`${API_BASE_URL}/admin/orders/`, {
          headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
        }).then(res => {
          console.log('Orders:', res.data);
          setOrders(res.data);
        }).catch(err => {
          console.error('Error fetching orders:', err);
          setError(err.response?.data?.detail || 'Failed to load orders');
        });
      }, []);

      return (
        <div>
          <h2>Orders</h2>
          {error && <div className="alert alert-danger">{error}</div>}
          {orders.length === 0 && !error && (
            <div className="alert alert-info">No orders available.</div>
          )}
          <table className="table table-striped">
            <thead>
              <tr>
                <th>ID</th>
                <th>User ID</th>
                <th>Restaurant</th>
                <th>Status</th>
                <th>Total</th>
                <th>Address</th>
                <th>Created</th>
              </tr>
            </thead>
            <tbody>
              {orders.map(o => (
                <tr key={o.order_id}>
                  <td>{o.order_id}</td>
                  <td>{o.user_id}</td>
                  <td>{o.restaurant?.name || 'N/A'}</td>
                  <td>{o.status}</td>
                  <td>${o.total_amount?.toFixed(2) || 'N/A'}</td>
                  <td>{o.delivery_address}</td>
                  <td>{o.created_at ? new Date(o.created_at).toLocaleString() : 'N/A'}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      );
    };

    // Admin Update Order Status
    const AdminUpdateStatus = () => {
      const [orders, setOrders] = useState([]);
      const [statuses, setStatuses] = useState([]);
      const [searchId, setSearchId] = useState('');
      const [error, setError] = useState(null);
      const [selectedStatuses, setSelectedStatuses] = useState({});

      useEffect(() => {
        console.log('Fetching orders and statuses');
        axios.get(`${API_BASE_URL}/admin/orders/`, {
          headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
        }).then(res => {
          console.log('Orders:', res.data);
          setOrders(res.data);
        }).catch(err => {
          console.error('Error fetching orders:', err);
          setError(err.response?.data?.detail || 'Failed to load orders');
        });
        axios.get(`${API_BASE_URL}/admin/order-statuses/`, {
          headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
        }).then(res => {
          console.log('Statuses:', res.data);
          setStatuses(res.data);
        }).catch(err => {
          console.error('Error fetching statuses:', err);
          setError(err.response?.data?.detail || 'Failed to load statuses');
        });
      }, []);

      const handleStatusChange = (orderId, newStatus) => {
        setSelectedStatuses(prev => ({ ...prev, [orderId]: newStatus }));
      };

      const handleUpdate = async (orderId) => {
        const newStatus = selectedStatuses[orderId];
        if (!newStatus) return;
        try {
          console.log('Updating order status:', { orderId, newStatus });
          await axios.patch(`${API_BASE_URL}/admin/orders/${orderId}`, { status: newStatus }, {
            headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
          });
          setOrders(orders.map(o => o.order_id === orderId ? { ...o, status: newStatus } : o));
          setSelectedStatuses(prev => {
            const newStatuses = { ...prev };
            delete newStatuses[orderId];
            return newStatuses;
          });
        } catch (err) {
          console.error('Update status error:', err);
          setError(err.response?.data?.detail || 'Failed to update status');
        }
      };

      const filteredOrders = searchId
        ? orders.filter(o => o.order_id.toString().toLowerCase().includes(searchId.toLowerCase()))
        : orders;

      return (
        <div>
          <h2>Update Order Status</h2>
          {error && <div className="alert alert-danger">{error}</div>}
          <div className="mb-3">
            <input
              type="text"
              className="form-control"
              placeholder="Search by Order ID"
              value={searchId}
              onChange={e => setSearchId(e.target.value)}
            />
          </div>
          {filteredOrders.length === 0 && !error && (
            <div className="alert alert-info">No orders found.</div>
          )}
          <table className="table table-striped">
            <thead>
              <tr>
                <th>ID</th>
                <th>Restaurant</th>
                <th>Status</th>
                <th>New Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {filteredOrders.map(o => (
                <tr key={o.order_id}>
                  <td>{o.order_id}</td>
                  <td>{o.restaurant?.name || 'N/A'}</td>
                  <td>{o.status}</td>
                  <td>
                    <select
                      className="form-control"
                      value={selectedStatuses[o.order_id] || ''}
                      onChange={e => handleStatusChange(o.order_id, e.target.value)}
                    >
                      <option value="">Select status</option>
                      {statuses.filter(s => s !== o.status).map(s => (
                        <option key={s} value={s}>{s}</option>
                      ))}
                    </select>
                  </td>
                  <td>
                    <button
                      className="btn btn-primary btn-sm"
                      onClick={() => handleUpdate(o.order_id)}
                      disabled={!selectedStatuses[o.order_id]}
                    >Update</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      );
    };

    // Admin Add Restaurant
    const AdminAddRestaurant = () => {
      const [formData, setFormData] = useState({
        name: '',
        description: '',
        address: '',
        phone_number: '',
        email: '',
        is_active: true
      });
      const [error, setError] = useState(null);
      const navigate = useNavigate();

      const handleSubmit = async () => {
        try {
          console.log('Adding restaurant:', formData);
          await axios.post(`${API_BASE_URL}/admin/restaurants/`, formData, {
            headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
          });
          navigate('/admin/restaurants');
        } catch (err) {
          console.error('Add restaurant error:', err);
          setError(err.response?.data?.detail || 'Failed to add restaurant');
        }
      };

      return (
        <div>
          <h2>Add Restaurant</h2>
          {error && <div className="alert alert-danger">{error}</div>}
          <div className="mb-3">
            <label className="form-label">Name</label>
            <input
              type="text"
              className="form-control"
              value={formData.name}
              onChange={e => setFormData({ ...formData, name: e.target.value })}
            />
          </div>
          <div className="mb-3">
            <label className="form-label">Description</label>
            <textarea
              className="form-control"
              value={formData.description}
              onChange={e => setFormData({ ...formData, description: e.target.value })}
            ></textarea>
          </div>
          <div className="mb-3">
            <label className="form-label">Address</label>
            <input
              type="text"
              className="form-control"
              value={formData.address}
              onChange={e => setFormData({ ...formData, address: e.target.value })}
            />
          </div>
          <div className="mb-3">
            <label className="form-label">Phone Number</label>
            <input
              type="tel"
              className="form-control"
              value={formData.phone_number}
              onChange={e => setFormData({ ...formData, phone_number: e.target.value })}
            />
          </div>
          <div className="mb-3">
            <label className="form-label">Email</label>
            <input
              type="email"
              className="form-control"
              value={formData.email}
              onChange={e => setFormData({ ...formData, email: e.target.value })}
            />
          </div>
          <div className="mb-3">
            <label className="form-label">Active</label>
            <select
              className="form-control"
              value={formData.is_active}
              onChange={e => setFormData({ ...formData, is_active: e.target.value === 'true' })}
            >
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </div>
          <button className="btn btn-primary" onClick={handleSubmit}>Create</button>
        </div>
      );
    };

    // Admin Users
    const AdminUsers = () => {
      const [users, setUsers] = useState([]);
      const [error, setError] = useState(null);

      useEffect(() => {
        console.log('Fetching users');
        axios.get(`${API_BASE_URL}/admin/users/`, {
          headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
        }).then(res => {
          console.log('Users:', res.data);
          setUsers(res.data);
        }).catch(err => {
          console.error('Error fetching users:', err);
          setError(err.response?.data?.detail || 'Failed to load users');
        });
      }, []);

      return (
        <div>
          <h2>Users</h2>
          {error && <div className="alert alert-danger">{error}</div>}
          {users.length === 0 && !error && (
            <div className="alert alert-info">No users available.</div>
          )}
          <table className="table table-striped">
            <thead>
              <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Role</th>
                <th>Phone</th>
                <th>Active</th>
              </tr>
            </thead>
            <tbody>
              {users.map(u => (
                <tr key={u.user_id}>
                  <td>{u.user_id}</td>
                  <td>{u.username}</td>
                  <td>{u.role}</td>
                  <td>{u.phone_number}</td>
                  <td>{u.is_active ? 'Yes' : 'No'}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      );
    };

    // App Component
    const App = () => {
      console.log('Rendering App component');
      return (
        <BrowserRouter>
          <AuthProvider>
            <CartProvider>
              <Navbar />
              <Routes>
                <Route path="/" element={<Home />} />
                <Route path="/restaurant/:restaurantId" element={<RestaurantMenu />} />
                <Route path="/order" element={<OrderForm />} />
                <Route path="/order-success" element={<OrderSuccess />} />
                <Route path="/login" element={<Login />} />
                <Route path="/register" element={<Register />} />
                <Route path="/admin/*" element={<AdminDashboard />} />
              </Routes>
            </CartProvider>
          </AuthProvider>
        </BrowserRouter>
      );
    };

    // Render App
    console.log('Mounting React app');
    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
